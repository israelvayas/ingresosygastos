<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Ingresos y Gastos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f4f6f9; margin:0; padding:15px; color:#333; }
    h1 { text-align:center; color:#444; font-size:1.6rem; }
    .container { max-width:1000px; margin:auto; }

    /* Botones de navegaci√≥n */
    .nav-buttons { text-align:center; margin-bottom:10px; }
    .nav-buttons button {
      padding:8px 15px; margin:0 5px; border:none; border-radius:8px;
      background:#4cafef; color:white; font-weight:bold; cursor:pointer; transition:.3s;
    }
    .nav-buttons button:hover { background:#2a9adf; }

    /* Resumen ingresos/gastos */
    .summary { display:flex; justify-content:space-around; margin-bottom:20px; text-align:center; flex-wrap:wrap; gap:10px; }
    .card { background:white; padding:15px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); flex:1 1 30%; min-width:120px; }
    .income { color:green; font-weight:bold; font-size:1.1rem;}
    .expense { color:red; font-weight:bold; font-size:1.1rem;}
    .balance { color:#444; font-weight:bold; font-size:1.1rem;}

    /* Formulario */
    .form { display:grid; grid-template-columns:1fr 1fr 1fr auto auto; gap:10px; margin-bottom:20px; }
    input, select, button { padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
    button { background:#4cafef; color:white; font-weight:bold; border:none; cursor:pointer; transition:.3s; }
    button:hover { background:#2a9adf; }

    /* Tabla principal */
    .table-container { overflow-x:auto; border-radius:10px; }
    table { width:100%; border-collapse:collapse; background:white; min-width:600px; }
    th, td { padding:10px; text-align:center; border-bottom:1px solid #eee; }
    th { background:#4cafef; color:white; }
    tr:nth-child(even) { background:#f9f9f9; }
    .ingreso-row { background-color:#e6f7ff; color:green; font-weight:bold;}
    .gasto-row { background-color:#ffe6e6; color:red; font-weight:bold;}

    .bar-container { background:#ddd; border-radius:5px; height:18px; width:100%; position:relative; margin-top:3px; }
    .bar { height:18px; border-radius:5px; text-align:right; padding-right:5px; color:white; font-weight:bold; font-size:.75rem; line-height:18px; }
    .bar.ingreso { background-color:green; }
    .bar.gasto { background-color:red; }

    /* Responsive m√≥vil */
    @media (max-width:768px) {
      .form { grid-template-columns:1fr; }
      .form button { width:100%; }
      .summary { flex-direction:column; align-items:center; }
      .card { width:90%; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üí∞ Control de Ingresos y Gastos</h1>

  <div class="nav-buttons">
    <button onclick="showTab('main')">üè† Inicio</button>
    <button onclick="showTab('interests')">üìà Intereses</button>
  </div>

  <!-- Secci√≥n principal -->
  <div id="main" style="display:block;">
    <div class="summary">
      <div class="card"><h3>Ingresos</h3><p class="income" id="total-income">$0</p></div>
      <div class="card"><h3>Gastos</h3><p class="expense" id="total-expense">$0</p></div>
      <div class="card"><h3>Balance</h3><p class="balance" id="balance">$0</p></div>
    </div>

    <form id="transaction-form" class="form">
      <input type="text" id="desc" placeholder="Descripci√≥n" required>
      <input type="number" id="amount" placeholder="Monto" required>
      <select id="type">
        <option value="ingreso">Ingreso</option>
        <option value="gasto">Gasto</option>
      </select>
      <button type="submit">‚ûï Agregar</button>
      <button type="button" onclick="exportToExcel()">üì• Exportar a Excel</button>
    </form>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th>Tipo</th><th>Progreso</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="transactions"></tbody>
      </table>
    </div>
  </div>

  <!-- Secci√≥n intereses -->
  <div id="interests" style="display:none;">
    <h2>üìä Inter√©s Compuesto y Acumulado</h2>

    <h3>Proyecci√≥n de inter√©s (sobre balance actual)</h3>
    <table border="1" style="width:100%; margin-bottom:20px;">
      <thead>
        <tr><th>Intervalo</th><th>Inter√©s estimado</th><th>Saldo estimado</th></tr>
      </thead>
      <tbody id="projection-table"></tbody>
    </table>

    <h3>Intereses reales diarios acumulados</h3>
    <table border="1" style="width:100%;">
      <thead>
        <tr><th>Fecha</th><th>Inter√©s generado</th><th>Saldo</th></tr>
      </thead>
      <tbody id="daily-interest-table"></tbody>
    </table>
  </div>
</div>

<!-- Librer√≠a XLSX.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ---------------- Variables ---------------- */
const form = document.getElementById('transaction-form');
const transactionsEl = document.getElementById('transactions');
const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const balanceEl = document.getElementById('balance');

let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

/* ---------------- Inicializaci√≥n ---------------- */
renderTransactions();
applyPassiveIncome();
updateProjection();
saveDailyInterest();

/* ---------------- Formulario ---------------- */
form.addEventListener('submit',(e)=>{
  e.preventDefault();
  const desc = document.getElementById('desc').value;
  const amount = parseFloat(document.getElementById('amount').value);
  const type = document.getElementById('type').value;

  if(desc && amount){
    const transaction = createTransaction(desc, amount, type);
    transactions.unshift(transaction);
    saveAndRender();
    form.reset();
    updateProjection();
    saveDailyInterest();
  }
});

/* ---------------- Funciones ---------------- */
function createTransaction(desc, amount, type){
  const now = new Date();
  const fecha = now.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
  return {id:Date.now(), desc, amount, type, fecha};
}

function renderTransactions(){
  transactionsEl.innerHTML='';
  let totalIncome = 0, totalExpense = 0;
  transactions.forEach(t=>{ if(t.type==='ingreso') totalIncome+=t.amount; else totalExpense+=t.amount; });

  transactions.forEach(t=>{
    const row=document.createElement('tr');
    row.className = t.type==='ingreso'?'ingreso-row':'gasto-row';
    const total = t.type==='ingreso'?totalIncome:totalExpense;
    const widthPercent = total?(t.amount/total)*100:0;
    row.innerHTML=`
      <td>${t.fecha}</td>
      <td>${t.desc}</td>
      <td>$${t.amount.toFixed(2)}</td>
      <td>${t.type==='ingreso'?'‚úÖ Ingreso':'‚ùå Gasto'}</td>
      <td><div class="bar-container"><div class="bar ${t.type}" style="width:${widthPercent}%">${widthPercent.toFixed(1)}%</div></div></td>
      <td><button onclick="deleteTransaction(${t.id})">üóëÔ∏è</button></td>
    `;
    transactionsEl.appendChild(row);
  });

  totalIncomeEl.textContent=`$${totalIncome.toFixed(2)}`;
  totalExpenseEl.textContent=`$${totalExpense.toFixed(2)}`;
  balanceEl.textContent=`$${(totalIncome-totalExpense).toFixed(2)}`;
}

function saveAndRender(){
  localStorage.setItem('transactions', JSON.stringify(transactions));
  renderTransactions();
}

function deleteTransaction(id){
  transactions = transactions.filter(t=>t.id!==id);
  saveAndRender();
}

/* ---------------- Ingreso pasivo acumulado ---------------- */
function applyPassiveIncome(){
  const lastApplied = localStorage.getItem("lastPassiveIncome");
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let lastDate = lastApplied ? new Date(lastApplied) : null;
  if(!lastDate){ localStorage.setItem("lastPassiveIncome", today.toISOString()); return; }

  lastDate = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
  const daysDiff = Math.floor((today-lastDate)/(1000*60*60*24));

  if(daysDiff>0){
    let totalIncome = transactions.filter(t=>t.type==="ingreso").reduce((a,b)=>a+b.amount,0);
    let totalExpense = transactions.filter(t=>t.type==="gasto").reduce((a,b)=>a+b.amount,0);
    let balance = totalIncome - totalExpense;
    if(balance>0){
      const dailyRate = 0.05/365;
      for(let i=1;i<=daysDiff;i++){
        const passiveAmount = balance*dailyRate;
        balance+=passiveAmount;
        const fecha=new Date(lastDate);
        fecha.setDate(lastDate.getDate()+i);
        const formattedDate = fecha.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
        transactions.unshift({id:Date.now()+i, desc:"Ingreso Pasivo", amount:passiveAmount, type:"ingreso", fecha:formattedDate});
      }
      saveAndRender();
    }
    localStorage.setItem("lastPassiveIncome", today.toISOString());
  }
}

/* ---------------- Intereses ---------------- */
function getCurrentBalance(){
  let totalIncome = transactions.filter(t=>t.type==='ingreso').reduce((a,b)=>a+b.amount,0);
  let totalExpense = transactions.filter(t=>t.type==='gasto').reduce((a,b)=>a+b.amount,0);
  return totalIncome-totalExpense;
}

function updateProjection(){
  const balance = getCurrentBalance();
  const dailyRate = 0.05/365;
  const tbody = document.getElementById('projection-table');
  tbody.innerHTML='';
  const intervals = [{name:'Diario',days:1},{name:'Semanal',days:7},{name:'Mensual',days:30},{name:'Anual',days:365}];
  intervals.forEach(i=>{
    const interest = balance*(Math.pow(1+dailyRate,i.days)-1);
    const finalBalance = balance+interest;
    tbody.innerHTML+=`<tr><td>${i.name}</td><td>$${interest.toFixed(2)}</td><td>$${finalBalance.toFixed(2)}</td></tr>`;
  });
}

function saveDailyInterest(){
  const dailyInterests = JSON.parse(localStorage.getItem('dailyInterests'))||[];
  const today = new Date().toLocaleDateString('es-ES');
  const balance = getCurrentBalance();
  const interest = balance*0.05/365;
  if(!dailyInterests.some(d=>d.fecha===today)){
    dailyInterests.push({fecha:today, interest:interest, balance:balance});
    localStorage.setItem('dailyInterests', JSON.stringify(dailyInterests));
  }
  updateDailyInterestTable();
}

function updateDailyInterestTable(){
  const dailyInterests = JSON.parse(localStorage.getItem('dailyInterests'))||[];
  const tbody = document.getElementById('daily-interest-table');
  tbody.innerHTML='';
  dailyInterests.forEach(d=>{
    tbody.innerHTML+=`<tr><td>${d.fecha}</td><td>$${d.interest.toFixed(2)}</td><td>$${d.balance.toFixed(2)}</td></tr>`;
  });
}

/* ---------------- Navegaci√≥n pesta√±as ---------------- */
function showTab(tab){
  document.getElementById('main').style.display = (tab==='main')?'block':'none';
  document.getElementById('interests').style.display = (tab==='interests')?'block':'none';
}

/* ---------------- Exportar Excel ---------------- */
function exportToExcel(){
  const data = transactions.map(t=>({Fecha:t.fecha,Descripci√≥n:t.desc,Monto:t.amount,Tipo:t.type}));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Transacciones");
  XLSX.writeFile(wb,"control_ingresos_gastos.xlsx");
}
</script>
</body>
</html>
